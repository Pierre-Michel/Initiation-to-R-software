---
title: "Initiation to R software Session V"
author: "Pierre Michel"
date: "Master AMSE 1st year, 2019"
output:
  beamer_presentation: default
  ioslides_presentation: 
    transition: slower
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Loops and tests


## Loops and tests

R has instructions that are similar to that of C language.

Main instructions:

- `for (... in ...) {}`: runs code in `{}` for some values. 
- `while (...) {}`: runs code in `{}` while a condition is true.
- `if (...) {} else {}`: runs code in `{}` conditionally.

In most cases, loops can be avoided by **vectorization** and the use of **simpler** and less **time-consuming** functions (e.g\ `apply()`).

If objects are created in a loop, always **define them first**.


## Loops and tests: example 1

_Aim_: create a vector that equals 0 if x equals 3, 1 elsewhere, then add this vector to x.

```{r, echo  = T, eval = F}
# Try this example !
# Solution 1: Loop
system.time({
  x = sample(1:100, 10, rep = T)
  y = numeric(length(x))
  for(i in 1:length(x)) {
    if (x[i] == 3) y[i] = 0  
    else y[i] = 1
  }
})

# Solution 2: Vectorization
system.time({
  x = sample(1:100, 10, rep = T)
})

```


## Loops and tests: example 2

_Aim_: sum on the columns of a matrix.

```{r, echo  = T, eval = F}
# Try this example !
# Solution 1: Loop
system.time({
  M = matrix(sample(1:10, 20, rep = T), 5, 4)
  SM = numeric(length(ncol(M)))
  for (j in 1:ncol(M)) {
    SM[j] = sum(M[,j])
  }
})

# Solution 2: Function
system.time({
  M = matrix(sample(1:10, 20, rep = T), 5, 4)
  SM = apply(M, 2, sum)
})

```


# R programming


## Write a program in R

A program in R is a **sequence of instructions**, saved in a text file (a script in format `.txt` or `.R`).

A program can be run using the function `source()`. 

Useful when you want to perform the same task several times.


## Write a program in R: example

_Aim_: plot the same graphic several times, for 3 different species

```{r, echo  = T, eval = F}
# Solution 1: 
layout(matrix(1:3,3,1)) 
data(iris)
data = iris[iris$Species == "setosa",]
plot(data$Sepal.Length, data$Sepal.Width,
          xlab = "Sepal Length", ylab = "Sepal Width")
title("setosa")
data = iris[iris$Species == "versicolor",]
plot(data$Sepal.Length, data$Sepal.Width,
          xlab = "Sepal Length", ylab = "Sepal Width")
title("versicolor")
data = iris[iris$Species == "virginica",]
plot(data$Sepal.Length, data$Sepal.Width,
          xlab = "Sepal Length", ylab = "Sepal Width")
title("virginica")
```


## Write a program in R: example

_Aim_: plot the same graphic several times, for 3 different species

```{r, echo  = T, eval = F}
# Solution 2: save the program in file "mySpecies.R"
# The following commands should be saved in a script
layout(matrix(1:3,3,1)) 
data(iris)
species = unique(iris$Species)
for (i in 1:length(species)) {
  data = iris[ iris$Species == species[i],]
  plot(data$Sepal.Length, data$Sepal.Width,
          xlab = "Sepal Length", ylab = "Sepal Width")
  title(species[i])
}
# Then, run the program saved in a script
source("mySpecies.R")
```


## Write a program in R: example

_Aim_: plot the same graphic several times, for 3 different species

```{r, echo  = F, eval = T, fig.height = 6}
# Solution 2: save the program in file "mySpecies.R"
# The following commands should be saved in a script
layout(matrix(1:3,1,3)) 
data(iris)
species = unique(iris$Species)
for (i in 1:length(species)) {
  data = iris[ iris$Species == species[i],]
  plot(data$Sepal.Length, data$Sepal.Width,
          xlab = "Sepal Length", ylab = "Sepal Width")
  title(species[i])
}
```


# Functions

## Functions

To use a program as much as we want, by changing its parameters at will, we can **write a function**. The written functions will have the same properties as those from R packages.

A function is an R program with **variable parameters** given in the `function()` instruction that initiates function writing.

Syntax: `function_name = function(p1, p2, p3, ...) {}`

The instructions of the function are written in `{}`.


## Functions

To run, a function must be loaded in memory, this can be done in several ways:

- Type the commands on the keyboard
- Copy/paste them to an R editor
- save the function in a R file and load it with the command `source()`

If you want the function to be loaded when R starts, you can save it in a file with the extension `.Rda`, which will be loaded in memory if located in the working directory (use `getwd()`).


## Functions

```{r, echo  = T, eval = F}
# Solution 3: write a function saved in "myFun.R"
# The following lines should be saved in the script
myFun = function(specie, data) {
  data = iris[iris$Species == specie,]
  plot(data$Sepal.Length, data$Sepal.Width,
          xlab = "Sepal Length", ylab = "Sepal Width")
  title(specie)
}
# Run the function
layout(matrix(1:3,3,1))
source("myFun.R")
myFun("setosa", iris)
myFun("versicolor", iris)
myFun("virginica", iris)
```

## Functions 

There are two ways to specify the parameters of a function `fun = function(p1, p2, p3)`:

- by their position: `fun(x,y,z)` is equivalent to `fun(p1=x, p2=y, p3=z)`
- by their name: `fun(p2=y, p1=x, p3=z)`

Default parameters can be defined: `fun = function(p1=1:2, p2=c(T,F), p3=c("1","3"))`

Use `print()` to print the content of an object in a function.

## Functions 

```{r, echo  = T, eval = T}
# Use print
square = function(x) print(x*x)
square(3)
# Use default parameter
msd = function(x = 1:10) {
  m = mean(x)
  s = sd(x)
  print(c(m,s))
}
msd()
msd(1:100)
```




# Basic functions

## Basic mathematical functions

\small
```{r useful_fun, echo=F, eval=T, warning=F}
knitr::kable(data.frame(function_name = c("sum(x)", "prod(x)", "max(x), min(x)", "which.max(x)", "which.min(x)", "range(x)", "mean(x)","median(x)"),
                        description = c("Sum of the elements of x", "Product of the elements of x", "Maximum, minimum of the elements of", "Returns the index of the maximum of the elements of x", "Returns the index of the minimum of the elements of x", "Similar to c(min(x), max(x))", "Mean of the elements of x", "Median of the elements of x")))
```


## Other basic mathematical functions

\small
```{r useful_fun2, echo=F, eval=T, warning=F}
knitr::kable(data.frame(function_name = c("var(x)", "cov(x)", "cor(x)", "sd(x)", "round(x,n)", "rev(x)", "sort(x)", "rank(x)", "scale(x)"),
                        description = c("Variance of the elements of x", "Covariance matrix if x is a matrix","Correlation matrix of x if x is a matrix or a data.frame", "Standard deviation of the elements of x", "Rounds the elements of x to n decimals", "Reverse the order of the elements of x", "Sort the elements of x in ascending order", "Rank the elements of x", "Scale (center and reduce) x")))
```


## ... and other basic mathematical functions...

\small
```{r useful_fun3, echo=F, eval=T, warning=F}
knitr::kable(data.frame(function_name = c("pmin(x,y,...)","cumsum(x)","cumprod()", "cummin()", "cummax()","match(x,y)","choose(x,k)","na.omit()","na.fail()"),
                        description = c("A vector whose element i is the minimum of x[i] and y[i]",
                                        "A vector whose element i is the sum of x[i] and y[i]",
                                        "Similar as cumsum() with product",
                                        "Similar as cumsum() with minimum",
                                        "Similar as cumsum() with maximum",
                                        "Vector of same length as x with elements of x that are in y",
                                        "Binomial coefficient","Remove observations with missing values",
                                        "Returns an error message if x contains at least one NA")))
```


## ... and others

\small
```{r useful_fun4, echo=F, eval=T, warning=F}
knitr::kable(data.frame(function_name = c("unique()","table()","subset()", "sample(x,n)"),
                        description = c("Returns a similar object without duplicates",
                                        "Returns table of counts of the values of x",
                                        "Returns a selection of x based on criteria",
                                        "Random sampling of x of size n, without replacement")))
```

